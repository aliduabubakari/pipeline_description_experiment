{
  "unique_key": "bcgov/medis-scheduler:dags/PCD-ETL.py",
  "repo": "bcgov/medis-scheduler",
  "repo_url": "https://github.com/bcgov/medis-scheduler",
  "stars": 0,
  "license": "Apache-2.0",
  "file_path": "dags/PCD-ETL.py",
  "detected_airflow_version": "2.x",
  "sampled_versions": [
    {
      "version": "latest",
      "commit": "f6ab99081bd25d2af7f5e8c1f5f7fa18c169965a",
      "code": "#\n# Licensed to the Apache Software Foundation (ASF) under one\n# or more contributor license agreements.  See the NOTICE file\n# distributed with this work for additional information\n# regarding copyright ownership.  The ASF licenses this file\n# to you under the Apache License, Version 2.0 (the\n# \"License\"); you may not use this file except in compliance\n# with the License.  You may obtain a copy of the License at\n#\n#   http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing,\n# software distributed under the License is distributed on an\n# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n# KIND, either express or implied.  See the License for the\n# specific language governing permissions and limitations\n# under the License.\n\nfrom __future__ import annotations\n\nimport datetime\n\nimport pendulum\n\nimport kubernetes.client as k8s\nimport kubernetes_asyncio.client as async_k8s\n\nfrom airflow.models.dag import DAG\nfrom airflow.operators.bash import BashOperator\nfrom airflow.operators.empty import EmptyOperator\nfrom airflow.providers.http.operators.http import HttpOperator\nfrom airflow.providers.cncf.kubernetes.operators.pod import KubernetesPodOperator\nfrom airflow.providers.cncf.kubernetes.callbacks import KubernetesPodOperatorCallback\nfrom airflow.providers.cncf.kubernetes.operators.job import KubernetesJobOperator\nfrom airflow.operators.python_operator import PythonOperator\nfrom airflow.exceptions import AirflowSkipException\nfrom airflow.utils.email import send_email\nfrom airflow.models import Variable\n\npcd_etl_schedule = Variable.get(\"pcd_etl_schedule\")\n\nwith DAG(\n    dag_id=\"pcd-etl\",\n    schedule=None if pcd_etl_schedule == \"None\" else pcd_etl_schedule,\n    start_date=pendulum.datetime(2021, 1, 1, tz=\"UTC\"),\n    catchup=False,\n    dagrun_timeout=datetime.timedelta(minutes=60),\n    tags=[\"etl\", \"pcd\"],\n   # params={\"example_key\": \"example_value\"},\n) as dag:\n\n    # Function to generate HTML content for email in case of failure\n    def generate_failed_html(failed_ids,dag_id):\n        current_time = datetime.datetime.now().strftime(\"%Y-%m-%d %H:%M:%S UTC\")\n        html_content = \"<html><head></head><body>%s Airflow %s DAG run at %s failed<p>Automatically generated message in case of failure.</p><b>Failed Task IDs</b><ul>\" % (Variable.get(\"Environment\"),dag_id,current_time)\n        for failed_id in failed_ids:\n            html_content += f\"<li>{failed_id}</li>\"\n        html_content += \"</ul>Please access Airflow and review tasks run: <a href='\" + \\\n           Variable.get(\"airflow_url\") + \"'>\" + \\\n           Variable.get(\"airflow_url\") + \"</a></body></html>\"\n        print(html_content)\n        return html_content\n    \n    # Function to generate HTML content for email in case of success\n    def generate_success_html(dag_id):\n        current_time = datetime.datetime.now().strftime(\"%Y-%m-%d %H:%M:%S UTC\")\n        html_content = \"<html><head></head><body>%s Airflow %s DAG run at %s succeeded<p>Automatically generated message in case of success.</p></body></html>\" % (Variable.get(\"Environment\"),dag_id,current_time)\n        print(html_content)\n        return html_content\n\n    # Function to check all previous upstream tasks and notify user if dag run results\n    def get_failed_ids_send_email(ds=None, **kwargs):\n        ti = kwargs['ti']\n        dag_run = kwargs['dag_run']\n        dag_id = kwargs['dag'].dag_id\n        # Get all tasks that are upstream of this task\n        upstream_task_ids = ti.task.get_flat_relative_ids(upstream=True)\n        # Get list of all tasks that have failed for this DagRun\n        failed_task_instances = dag_run.get_task_instances(state='failed')\n        # Get intersection of the sets to get upstream tasks that failed\n        failed_upstream_task_ids = upstream_task_ids.intersection(\n            [task.task_id for task in failed_task_instances])\n        print(f\"Upstream tasks that failed: {failed_upstream_task_ids}\")\n        # If no upstream tasks have failed, send an email with success message\n        if len(failed_upstream_task_ids) == 0:\n            send_email(\n                to=Variable.get(\"PCD_ETL_email_list_success\"),\n                subject=Variable.get(\"Environment\") + 'Airflow ' + dag_id + ' run SUCCEEDED!',\n                html_content=generate_success_html(dag_id),\n            )\n        # If there are failed upstream tasks, send an email with the failed task IDs\n        elif len(failed_upstream_task_ids) > 0:\n            send_email(\n                to=Variable.get(\"ETL_email_list_alerts\"),\n                subject=Variable.get(\"Environment\") + 'Airflow ' + dag_id + ' run FAILED!',\n                html_content=generate_failed_html(failed_upstream_task_ids,dag_id),\n            )\n        return failed_upstream_task_ids\n\n\n    etl_job_task = KubernetesJobOperator(\n        task_id='PCD_file_upload',\n        job_template_file='{{var.value.pcd_job}}',\n    )\n\n    failed_tasks_notification = PythonOperator(\n        task_id=\"ETL_Notification\", python_callable=get_failed_ids_send_email, trigger_rule=\"all_done\")\n\n    start_pcd_extract_1 = EmptyOperator(\n        task_id=\"Start_PCD_Extract_1\",\n    )\n\n    start_pcd_extract_2 = EmptyOperator(\n        task_id=\"Start_PCD_Extract_2\",\n    )\n\n    financial_expense_task = HttpOperator(\n        task_id='Financial_Expense',\n        method='POST',\n        endpoint='{{var.value.pcd_financial_expense_url}}',\n        response_check=lambda response: response.json()[\"statusCode\"]==200,\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"SUBMITTED\", \"healthAuthority\":\"\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    )\n\n    upcc_financial_reporting_task = HttpOperator(\n        task_id='UPCC_Financial_Reportingr',\n        method='POST',\n        endpoint='{{var.value.pcd_upcc_financial_reporting_url}}',\n        response_check=lambda response: response.json()[\"statusCode\"]==200,\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"SUBMITTED\", \"healthAuthority\":\"\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    )\n    \n    chc_financial_reporting_task = HttpOperator(\n        task_id='CHC_Financial_reporting',\n        method='POST',\n        endpoint='{{var.value.pcd_chc_financial_reporting_url}}',\n        response_check=lambda response: response.json()[\"statusCode\"]==200,\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"SUBMITTED\", \"healthAuthority\":\"\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    ) \n\n    pcn_financial_reporting_task = HttpOperator(\n        task_id='PCN_Financial_Reporting',\n        method='POST',\n        endpoint='{{var.value.pcd_pcn_financial_reporting_url}}',\n        response_check=lambda response: response.json()[\"statusCode\"]==200,\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"SUBMITTED\", \"healthAuthority\":\"\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    )\n\n    nppcc_financial_reporting_task = HttpOperator(\n        task_id='NPPCC_Financial_Reporting',\n        method='POST',\n        endpoint='{{var.value.pcd_nppcc_financial_reporting_url}}',\n        response_check=lambda response: response.json()[\"statusCode\"]==200,\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"SUBMITTED\", \"healthAuthority\":\"\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    )\n\n    fiscal_year_reporting_dates_task = HttpOperator(\n        task_id='Fiscal_Year_Reporting_Dates',\n        method='POST',\n        endpoint='{{var.value.pcd_fiscal_year_reporting_dates_url}}',\n        response_check=lambda response: response.json()[\"statusCode\"]==200,\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"SUBMITTED\", \"healthAuthority\":\"\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    )\n\n    upcc_pcps_task = HttpOperator(\n        task_id='UPCC_Primary_Care_Patient_Services',\n        method='POST',\n        endpoint='{{var.value.pcd_upcc_pcps_url}}',\n        response_check=lambda response: response.json()[\"statusCode\"]==200,\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"SUBMITTED\", \"healthAuthority\":\"\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    )\n\n    chc_pcps_task = HttpOperator(\n        task_id='CHC_Primary_Care_Patient_Services',\n        method='POST',\n        endpoint='{{var.value.pcd_chc_pcps_url}}',\n        response_check=lambda response: response.json()[\"statusCode\"]==200,\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"SUBMITTED\", \"healthAuthority\":\"\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    )\n\n    practitioner_role_mapping_task = HttpOperator(\n        task_id='Practitioner_Role_Mapping',\n        method='POST',\n        endpoint='{{var.value.pcd_practitioner_role_mapping_url}}',\n        response_check=lambda response: response.json()[\"statusCode\"]==200,\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"SUBMITTED\", \"healthAuthority\":\"\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    )\n\n    status_tracker_task = HttpOperator(\n        task_id='Status_Tracker',\n        method='POST',\n        endpoint='{{var.value.pcd_status_tracker_url}}',\n        response_check=lambda response: response.json()[\"statusCode\"]==200,\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"SUBMITTED\", \"healthAuthority\":\"\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    )\n\n    hr_records_task = HttpOperator(\n        task_id='HR_Records',\n        method='POST',\n        endpoint='{{var.value.pcd_hr_records_url}}',\n        response_check=lambda response: response.json()[\"statusCode\"]==200,\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"SUBMITTED\", \"healthAuthority\":\"\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    )\n\n    provincial_risk_tracking_task = HttpOperator(\n        task_id='Provincial_Risk_Tracking',\n        method='POST',\n        endpoint='{{var.value.pcd_provincial_risk_tracking_url}}',\n        response_check=lambda response: response.json()[\"statusCode\"]==200,\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"SUBMITTED\", \"healthAuthority\":\"\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    )\n  \n    decision_log_task = HttpOperator(\n        task_id='Decision_Log',\n        method='POST',\n        endpoint='{{var.value.pcd_decision_log_url}}',\n        response_check=lambda response: response.json()[\"statusCode\"]==200,\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"SUBMITTED\", \"healthAuthority\":\"\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    )\n\n    ha_hierarchy_task = HttpOperator(\n        task_id='HA_Hierarchy',\n        method='POST',\n        endpoint='{{var.value.pcd_ha_hierarchy_url}}',\n        response_check=lambda response: response.json()[\"statusCode\"]==200,\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"SUBMITTED\", \"healthAuthority\":\"\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    )\n\n    upcc_budget_task = HttpOperator(\n        task_id='UPPC_Budget',\n        method='POST',\n        endpoint='{{var.value.pcd_upcc_budget_url}}',\n        response_check=lambda response: response.json()[\"statusCode\"]==200,\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"SUBMITTED\", \"healthAuthority\":\"\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    ) \n\n    chc_budget_task = HttpOperator(\n        task_id='CHC_Budget',\n        method='POST',\n        endpoint='{{var.value.pcd_chc_budget_url}}',\n        response_check=lambda response: response.json()[\"statusCode\"]==200,\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"SUBMITTED\", \"healthAuthority\":\"\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    )\n\n    pcn_budget_task = HttpOperator(\n        task_id='PCN_Budget',\n        method='POST',\n        endpoint='{{var.value.pcd_pcn_budget_url}}',\n        response_check=lambda response: response.json()[\"statusCode\"]==200,\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"SUBMITTED\", \"healthAuthority\":\"\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    )\n\n    nppcc_budget_task = HttpOperator(\n        task_id='NPPCC_Budget',\n        method='POST',\n        endpoint='{{var.value.pcd_nppcc_budget_url}}',\n        response_check=lambda response: response.json()[\"statusCode\"]==200,\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"SUBMITTED\", \"healthAuthority\":\"\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    )\n\n    check_pcd_folder_task = KubernetesJobOperator(\n        task_id='Check_PCD_Shared_Folder',\n        job_template_file='{{var.value.pcd_emtydir_job}}',\n        wait_until_job_complete=True,\n    )\n\n    check_pcd_sftp_folder_task = KubernetesJobOperator(\n        task_id='Check_PCD_SFTP_Folder',\n        job_template_file='{{var.value.pcd_emtysftp_job}}',\n        wait_until_job_complete=True,\n    )\n\n    check_pcd_sftp_folder_task >> check_pcd_folder_task >> start_pcd_extract_1\n  \n    start_pcd_extract_1 >> status_tracker_task >> start_pcd_extract_2\n    start_pcd_extract_1 >> financial_expense_task >> start_pcd_extract_2\n    start_pcd_extract_1 >> upcc_financial_reporting_task >> start_pcd_extract_2\n    start_pcd_extract_1 >> chc_financial_reporting_task >> start_pcd_extract_2\n    start_pcd_extract_1 >> pcn_financial_reporting_task >> start_pcd_extract_2\n    start_pcd_extract_1 >> nppcc_financial_reporting_task >> start_pcd_extract_2\n    start_pcd_extract_1 >> fiscal_year_reporting_dates_task >> start_pcd_extract_2\n    start_pcd_extract_1 >> upcc_pcps_task >> start_pcd_extract_2\n    start_pcd_extract_1 >> chc_pcps_task >> start_pcd_extract_2\n    start_pcd_extract_1 >> practitioner_role_mapping_task >> start_pcd_extract_2\n\n    start_pcd_extract_2 >> provincial_risk_tracking_task >> etl_job_task\n    start_pcd_extract_2 >> decision_log_task >> etl_job_task\n    start_pcd_extract_2 >> ha_hierarchy_task >> etl_job_task\n    start_pcd_extract_2 >> hr_records_task >> etl_job_task\n    start_pcd_extract_2 >> upcc_budget_task >> etl_job_task\n    start_pcd_extract_2 >> chc_budget_task >> etl_job_task\n    start_pcd_extract_2 >> pcn_budget_task >> etl_job_task\n    start_pcd_extract_2 >> nppcc_budget_task >> etl_job_task\n\n\n    etl_job_task >> failed_tasks_notification\n\n\n\nif __name__ == \"__main__\":\n    dag.pcd()\n"
    },
    {
      "version": "earliest",
      "commit": "b1ecc6dacc28db6e6e54bb96e57eec0a894eaefb",
      "code": "#\n# Licensed to the Apache Software Foundation (ASF) under one\n# or more contributor license agreements.  See the NOTICE file\n# distributed with this work for additional information\n# regarding copyright ownership.  The ASF licenses this file\n# to you under the Apache License, Version 2.0 (the\n# \"License\"); you may not use this file except in compliance\n# with the License.  You may obtain a copy of the License at\n#\n#   http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing,\n# software distributed under the License is distributed on an\n# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n# KIND, either express or implied.  See the License for the\n# specific language governing permissions and limitations\n# under the License.\n\"\"\"Example DAG demonstrating the usage of the BashOperator.\"\"\"\nfrom __future__ import annotations\n\nimport datetime\n\nimport pendulum\n\nimport kubernetes.client as k8s\nimport kubernetes_asyncio.client as async_k8s\n\nfrom airflow.models.dag import DAG\nfrom airflow.operators.bash import BashOperator\nfrom airflow.operators.empty import EmptyOperator\nfrom airflow.providers.http.operators.http import HttpOperator\nfrom airflow.providers.cncf.kubernetes.operators.pod import KubernetesPodOperator\nfrom airflow.providers.cncf.kubernetes.callbacks import KubernetesPodOperatorCallback\nfrom airflow.providers.cncf.kubernetes.operators.job import KubernetesJobOperator\nfrom airflow.operators.python_operator import PythonOperator\nfrom airflow.exceptions import AirflowSkipException\nfrom airflow.utils.email import send_email\nfrom airflow.models import Variable\n\n\nwith DAG(\n    dag_id=\"pcd-etl\",\n    #schedule=\"0 0 * * *\",\n    schedule=None,\n    start_date=pendulum.datetime(2021, 1, 1, tz=\"UTC\"),\n    catchup=False,\n    dagrun_timeout=datetime.timedelta(minutes=60),\n    tags=[\"etl\", \"pcd\"],\n   # params={\"example_key\": \"example_value\"},\n) as dag:\n\n    # Function to generate HTML content for email in case of failure\n    def generate_failed_html(failed_ids,dag_id):\n        current_time = datetime.datetime.now().strftime(\"%Y-%m-%d %H:%M:%S UTC\")\n        html_content = \"<html><head></head><body><h1>Airflow %s DAG run at %s failed</h1><p>Automatically generated message in case of failure.</p><h2>Failed Task IDs</h2><ul>\" % (dag_id,current_time)\n        for failed_id in failed_ids:\n            html_content += f\"<li>{failed_id}</li>\"\n        html_content += \"</ul><h4>Please access Airflow and review tasks run: <a href='\" + \\\n           Variable.get(\"airflow_url\") + \"'>\" + \\\n           Variable.get(\"airflow_url\") + \"</a></h4></body></html>\"\n        print(html_content)\n        return html_content\n    \n    # Function to generate HTML content for email in case of success\n    def generate_success_html(dag_id):\n        current_time = datetime.datetime.now().strftime(\"%Y-%m-%d %H:%M:%S UTC\")\n        html_content = \"<html><head></head><body><h1>Airflow %s DAG run at %s succeeded</h1><p>Automatically generated message in case of success.</p></body></html>\" % (dag_id,current_time)\n        print(html_content)\n        return html_content\n\n    # Function to check all previous upstream tasks and notify user if dag run results\n    def get_failed_ids_send_email(ds=None, **kwargs):\n        ti = kwargs['ti']\n        dag_run = kwargs['dag_run']\n        dag_id = kwargs['dag'].dag_id\n        # Get all tasks that are upstream of this task\n        upstream_task_ids = ti.task.get_flat_relative_ids(upstream=True)\n        # Get list of all tasks that have failed for this DagRun\n        failed_task_instances = dag_run.get_task_instances(state='failed')\n        # Get intersection of the sets to get upstream tasks that failed\n        failed_upstream_task_ids = upstream_task_ids.intersection(\n            [task.task_id for task in failed_task_instances])\n        print(f\"Upstream tasks that failed: {failed_upstream_task_ids}\")\n        # If no upstream tasks have failed, send an email with success message\n        if len(failed_upstream_task_ids) == 0:\n            send_email(\n                to=Variable.get(\"ETL_email_list_success\"),\n                subject='Airflow ' + dag_id + ' run SUCCEEDED!',\n                html_content=generate_success_html(dag_id),\n            )\n        # If there are failed upstream tasks, send an email with the failed task IDs\n        elif len(failed_upstream_task_ids) > 0:\n            send_email(\n                to=Variable.get(\"ETL_email_list_alerts\"),\n                subject='Airflow ' + dag_id + ' run FAILED!',\n                html_content=generate_failed_html(failed_upstream_task_ids,dag_id),\n            )\n        return failed_upstream_task_ids\n\n\n    etl_job_task = KubernetesJobOperator(\n        task_id='PCD_file_upload',\n        job_template_file='{{var.value.pcd_job}}',\n    )\n\n    failed_tasks_notification = PythonOperator(\n        task_id=\"Failed_Tasks_Notification\", python_callable=get_failed_ids_send_email, trigger_rule=\"all_done\")\n\n    start_pcd_extract_1 = EmptyOperator(\n        task_id=\"Start_PCD_Extract_1\",\n    )\n\n    start_pcd_extract_2 = EmptyOperator(\n        task_id=\"Start_PCD_Extract_2\",\n    )\n\n    financial_expense_task = HttpOperator(\n        task_id='Financial_Expense',\n        method='POST',\n        endpoint='{{var.value.pcd_financial_expense_url}}',\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"COMPLETED\", \"healthAuthority\":\"FHA\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    )\n\n    upcc_financial_reporting_task = HttpOperator(\n        task_id='UPCC_Financial_Reportingr',\n        method='POST',\n        endpoint='{{var.value.pcd_upcc_budget_url}}',\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"COMPLETED\", \"healthAuthority\":\"IHA\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    )\n    \n    chc_financial_reporting_task = HttpOperator(\n        task_id='CHC_Financial_reporting',\n        method='POST',\n        endpoint='{{var.value.pcd_chc_financial_reporting_url}}',\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"COMPLETED\", \"healthAuthority\":\"VIHA\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    ) \n\n    pcn_financial_reporting_task = HttpOperator(\n        task_id='PCN_Financial_Reporting',\n        method='POST',\n        endpoint='{{var.value.pcd_pcn_financial_reporting_url}}',\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"COMPLETED\", \"healthAuthority\":\"NHA\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    )\n\n    status_tracker_task = HttpOperator(\n        task_id='Status_Tracker',\n        method='POST',\n        endpoint='{{var.value.pcd_status_tracker_url}}',\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"COMPLETED\", \"healthAuthority\":\"VCH\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    )\n  \n    decision_log_task = HttpOperator(\n        task_id='Decision_Log',\n        method='POST',\n        endpoint='{{var.value.pcd_decision_log_url}}',\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"COMPLETED\", \"healthAuthority\":\"FHA\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    )\n\n    ha_hierarchy_task = HttpOperator(\n        task_id='HA_Hierarchy',\n        method='POST',\n        endpoint='{{var.value.pcd_ha_hierarchy_url}}',\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"COMPLETED\", \"healthAuthority\":\"IHA\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    )\n\n    upcc_budget_task = HttpOperator(\n        task_id='UPPC_Budget',\n        method='POST',\n        endpoint='{{var.value.pcd_upcc_budget_url}}',\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"COMPLETED\", \"healthAuthority\":\"VIHA\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    ) \n\n    chc_budget_task = HttpOperator(\n        task_id='CHC_Budget',\n        method='POST',\n        endpoint='{{var.value.pcd_chc_budget_url}}',\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"COMPLETED\", \"healthAuthority\":\"NHA\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    )\n\n    pcn_budget_task = HttpOperator(\n        task_id='PCN_Budget',\n        method='POST',\n        endpoint='{{var.value.pcd_pcn_budget_url}}',\n        data='{\"version\" : \"\", \"startDate\" : \"\", \"endDate\":\"\", \"updatedMinDate\":\"\", \"updatedMaxDate\":\"\", \"draft\":false, \"deleted\":false, \"status\":\"COMPLETED\", \"healthAuthority\":\"VCH\", \"isHeaderAdded\": false}',\n        headers={\"Content-Type\": \"application/json\"},\n    )\n\n   # http_local_post_500_1 = BashOperator(\n   #     task_id='http_local_post_500_1',\n   #     bash_command='echo \"Failed Task\"; exit 1;',\n   #     dag=dag,\n   # )\n\n\n  \n    start_pcd_extract_1 >> status_tracker_task >> etl_job_task\n\n   # start_facility_extract >> http_local_post_500_1 >> start_ytd_extract\n\n    etl_job_task >> failed_tasks_notification\n\n\n\nif __name__ == \"__main__\":\n    dag.pcd()"
    }
  ],
  "sampled_time": "2025-08-22T20:30:01.505101Z",
  "analysis": {
    "is_production_dag": true,
    "is_airflow_2": true,
    "processing_type": "batch",
    "topology_pattern": "fan_in",
    "description": "ETL pipeline for PCD data with multiple HTTP API calls and Kubernetes job, ending with email notification",
    "complexity_score": 7
  }
}